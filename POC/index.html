<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Assistant POC — stable ask flow</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      :root {
        color-scheme: light dark;
      }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        margin: 2rem;
      }
      h1 {
        margin-top: 0;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(160px, 1fr));
        gap: 12px;
      }
      .product {
        border: 1px solid #d1d5db;
        padding: 12px;
        border-radius: 10px;
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: space-between;
      }
      .product button {
        padding: 6px 10px;
        border-radius: 8px;
        border: 1px solid #cbd5e1;
        background: #f8fafc;
        cursor: pointer;
        color: black;
      }
      #cart {
        margin: 12px 0 20px;
        font-weight: 600;
      }
      #suggestions {
        margin-top: 16px;
        max-width: 720px;
      }
      .card {
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 12px;
        margin: 8px 0;
      }
      .row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 8px;
      }
      .chip {
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid #94a3b8;
        background: #f8fafc;
        cursor: pointer;
        color: black;
      }
      .hint {
        font-size: 12px;
        opacity: 0.7;
        margin-top: 6px;
      }
    </style>
  </head>
  <body>
    <h1>Demo Shop</h1>

    <div class="grid">
      <div class="product">
        <span>Product A</span>
        <button data-testid="add">Add</button>
      </div>
      <div class="product">
        <span>Product B</span>
        <button data-testid="add">Add</button>
      </div>
      <div class="product">
        <span>Product C</span>
        <button data-testid="add">Add</button>
      </div>
    </div>

    <div id="cart">Cart count: <span id="cart-count">0</span></div>
    <div class="hint">
      Add at least 2 items to trigger rule → ask → final. Uses valid event types
      and string cartCount.
    </div>

    <div id="suggestions"></div>

    <script>
      (() => {
        // prevent multiple bindings during hot reload
        if (window.__pocWired) return;
        window.__pocWired = true;

        // -----------------------------
        // Config
        // -----------------------------
        const API_BASE = 'http://localhost:4000'; // FastAPI mock; proxies /suggest/get to agent:5001
        const SITE_ID = 'demo-site';
        const SESSION_ID = 'demo-session';
        const FINAL_COOLDOWN_MS = 30000;

        // -----------------------------
        // State
        // -----------------------------
        let shadowCount = 0;
        let lastContext = { matchedRules: [], eventType: 'page_load' };
        let activeTurn = null; // current Turn (ask/final) if any
        let cooldownUntil = 0; // timestamp until we can open a new convo

        // -----------------------------
        // DOM helpers
        // -----------------------------
        const $cart = document.querySelector('#cart-count');
        const $panel = document.querySelector('#suggestions');

        function setCart(n) {
          $cart.textContent = String(n);
        }
        function clearPanel() {
          $panel.innerHTML = '';
        }

        function renderAsk(turn) {
          $panel.innerHTML = '';
          const card = document.createElement('div');
          card.className = 'card';

          const msg = document.createElement('div');
          msg.textContent = turn.message || 'Continue?';
          card.appendChild(msg);

          const row = document.createElement('div');
          row.className = 'row';
          (turn.actions || []).forEach((a) => {
            const b = document.createElement('button');
            b.className = 'chip';
            b.textContent = a.label;
            b.addEventListener('click', () => handleAnswer(turn, a.id));
            row.appendChild(b);
          });
          card.appendChild(row);
          $panel.appendChild(card);
        }

        function renderFinal(turn) {
          $panel.innerHTML = '';
          if (turn.message) {
            const t = document.createElement('div');
            t.style.fontWeight = '600';
            t.style.margin = '6px 0';
            t.textContent = turn.message;
            $panel.appendChild(t);
          }
          (turn.suggestions || []).forEach((s) => {
            const card = document.createElement('div');
            card.className = 'card';
            if (s.title) {
              const h = document.createElement('div');
              h.style.fontWeight = '600';
              h.textContent = s.title;
              card.appendChild(h);
            }
            if (s.description) {
              const d = document.createElement('div');
              d.style.opacity = '.85';
              d.textContent = s.description;
              card.appendChild(d);
            }
            if (typeof s.price === 'number') {
              const p = document.createElement('div');
              p.textContent = s.currency
                ? `${s.price} ${s.currency}`
                : String(s.price);
              card.appendChild(p);
            }
            if (s.primaryCta) {
              const btn = document.createElement('button');
              btn.className = 'chip';
              btn.textContent = s.primaryCta.label || 'Action';
              btn.onclick = () => console.log('[cta]', s.primaryCta);
              card.appendChild(btn);
            }
            $panel.appendChild(card);
          });
        }

        function setActiveTurn(turn) {
          activeTurn = turn;
          if (!turn) {
            clearPanel();
            return;
          }
          if (turn.status === 'ask') renderAsk(turn);
          else if (turn.status === 'final') {
            renderFinal(turn);
            cooldownUntil = Date.now() + FINAL_COOLDOWN_MS;
          }
        }
        function canOpenConversation() {
          if (!activeTurn) return Date.now() >= cooldownUntil;
          if (activeTurn.status === 'ask') return false; // wait for answer
          return Date.now() >= cooldownUntil; // after final, respect cooldown
        }

        // -----------------------------
        // HTTP helpers
        // -----------------------------
        async function postJson(path, body) {
          const res = await fetch(`${API_BASE}${path}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
          });
          if (!res.ok) {
            let detail = '';
            try {
              detail = await res.text();
            } catch {}
            throw new Error(
              `${path} ${res.status} ${res.statusText} :: ${detail}`
            );
          }
          return res.json();
        }

        // -----------------------------
        // Agent suggest loop via API proxy
        // -----------------------------
        async function suggestNext({
          prevTurnId = null,
          answers = null,
          intentId = null,
        } = {}) {
          const req = {
            siteId: SITE_ID,
            sessionId: SESSION_ID,
            context: lastContext,
            intentId,
            prevTurnId,
            answers,
          };
          console.log('[suggest:get] ->', req);
          const res = await postJson('/suggest/get', req);
          console.log('[suggest:get] <-', res);
          setActiveTurn(res.turn);
        }

        async function handleAnswer(turn, choiceId) {
          await suggestNext({
            prevTurnId: turn.turnId,
            answers: { choice: choiceId },
            intentId: turn.intentId,
          });
        }

        // -----------------------------
        // Rule check (debounced, valid enum types)
        // -----------------------------
        let rcInFlight = false;
        let rcTimer = 0;
        const RC_MIN_INTERVAL = 120;
        let lastRCAt = 0;

        function scheduleRuleCheck(eventType /* "page_load" | "dom_click" */) {
          const now = Date.now();
          const delta = now - lastRCAt;
          if (delta < RC_MIN_INTERVAL) {
            clearTimeout(rcTimer);
            rcTimer = setTimeout(
              () => doRuleCheck(eventType),
              RC_MIN_INTERVAL - delta
            );
          } else {
            doRuleCheck(eventType);
          }
        }

        async function doRuleCheck(eventType) {
          if (rcInFlight) return;
          rcInFlight = true;
          lastRCAt = Date.now();

          const req = {
            siteId: SITE_ID,
            sessionId: SESSION_ID,
            event: {
              type: eventType, // MUST be one of: "dom_click" | "input_change" | "page_load" | "submit" | "route_change"
              ts: Date.now(),
              telemetry: {
                // attributes values must be strings per OpenAPI
                attributes: { cartCount: String(shadowCount) },
              },
            },
          };

          try {
            console.log('[rule:check] ->', req);
            const res = await postJson('/rule/check', req);
            console.log('[rule:check] <-', res);

            lastContext = {
              matchedRules: res.matchedRules,
              eventType: res.eventType,
            };

            if (res.shouldProceed && canOpenConversation()) {
              await suggestNext({});
            }
          } catch (err) {
            console.error('[rule:check] ERR', err.message);
          } finally {
            rcInFlight = false;
          }
        }

        // -----------------------------
        // Wire events
        // -----------------------------
        setCart(shadowCount);

        // page load
        scheduleRuleCheck('page_load');

        // Add buttons → update cart and rule check using a valid enum ("dom_click")
        document.addEventListener(
          'click',
          (e) => {
            const btn =
              e.target && e.target.closest("button[data-testid='add']");
            if (!btn) return;
            shadowCount += 1;
            setCart(shadowCount);
            scheduleRuleCheck('dom_click');
          },
          { capture: true }
        );
      })();
    </script>
  </body>
</html>
