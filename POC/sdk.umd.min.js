!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).DomSphereSDK={})}(this,function(t){"use strict";function e(t,e,n,s){return new(n||(n=Promise))(function(i,o){function r(t){try{c(s.next(t))}catch(t){o(t)}}function a(t){try{c(s.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(r,a)}c((s=s.apply(t,e||[])).next())})}function n(t,n,s){return e(this,arguments,void 0,function*(t,e,n,s={}){const i=yield fetch(new URL(e,t).toString(),{method:"POST",headers:Object.assign({"Content-Type":"application/json"},s),body:JSON.stringify(n)});if(!i.ok){const t=yield i.text().catch(()=>"");throw new Error(`HTTP ${i.status} ${i.statusText} @ ${e}: ${t}`)}return yield i.json()})}function s(t){const{baseUrl:s="http://localhost:4000",contractVersion:i=null,requestIdFactory:o,fetchHeaders:r={}}=t,a=()=>Object.assign({"X-Contract-Version":null!=i?i:void 0,"X-Request-Id":null==o?void 0:o()},r);return{ruleCheck:t=>n(s,"/rule/check",t,a()),suggestGet:t=>n(s,"/suggest/get",t,a()),ruleTrackGet:()=>function(t,n){return e(this,arguments,void 0,function*(t,e,n={}){const s=yield fetch(new URL(e,t).toString(),{method:"GET",headers:Object.assign({"Content-Type":"application/json"},n)});if(!s.ok){const t=yield s.text().catch(()=>"");throw new Error(`HTTP ${s.status} ${s.statusText} @ ${e}: ${t}`)}return yield s.json()})}(s,"/rule/track",a())}}"function"==typeof SuppressedError&&SuppressedError;class i{constructor(){this.m=new Map}on(t,e){this.m.has(t)||this.m.set(t,new Set);const n=this.m.get(t);return n?n.add(e):this.m.set(t,new Set([e])),()=>this.off(t,e)}off(t,e){var n;null===(n=this.m.get(t))||void 0===n||n.delete(e)}emit(t,...e){var n;null===(n=this.m.get(t))||void 0===n||n.forEach(t=>{try{t(...e)}catch(t){}})}}function o(t,e,n,s){var i,o,r,a;t.innerHTML="";const c=document.createElement("div");if(c.style.border="1px solid #e5e7eb",c.style.borderRadius="12px",c.style.padding="12px",c.style.margin="8px 0",e.message){const t=document.createElement("div");t.textContent=e.message,t.style.fontWeight="600",c.appendChild(t)}if(null===(i=e.actions)||void 0===i?void 0:i.length){const t=document.createElement("div");t.style.display="flex",t.style.flexWrap="wrap",t.style.gap="8px",t.style.marginTop="10px",e.actions.forEach(e=>{const s=document.createElement("button");s.textContent=e.label,s.onclick=()=>n(e),s.style.padding="6px 10px",s.style.borderRadius="8px",s.style.border="1px solid #d1d5db",t.appendChild(s)}),c.appendChild(t)}if(null===(r=null===(o=e.form)||void 0===o?void 0:o.fields)||void 0===r?void 0:r.length){const t=document.createElement("form");if(t.style.marginTop="12px",e.form.title){const n=document.createElement("div");n.textContent=e.form.title,n.style.fontWeight="600",t.appendChild(n)}e.form.fields.forEach(e=>{var n,s;const i=document.createElement("div");i.style.marginTop="8px";const o=document.createElement("label");let r;switch(o.textContent=e.label+(e.required?" *":""),o.style.display="block",o.style.marginBottom="4px",i.appendChild(o),e.type){case"textarea":{const t=document.createElement("textarea");t.name=e.key,t.required=!!e.required,r=t;break}case"select":{const t=document.createElement("select");t.name=e.key,t.required=!!e.required,(null!==(n=e.options)&&void 0!==n?n:[]).forEach(e=>{var n;const s=document.createElement("option");s.value=String(e.value),s.textContent=null!==(n=e.label)&&void 0!==n?n:String(e.value),t.appendChild(s)}),r=t;break}case"radio":{const t=document.createElement("div");(null!==(s=e.options)&&void 0!==s?s:[]).forEach(n=>{var s;const i=document.createElement("label");i.style.marginRight="8px";const o=document.createElement("input");o.type="radio",o.name=e.key,o.value=String(n.value),i.appendChild(o),i.appendChild(document.createTextNode(null!==(s=n.label)&&void 0!==s?s:String(n.value))),t.appendChild(i)}),r=t;break}default:{const t=document.createElement("input");t.type="text",t.name=e.key,r=t}}i.appendChild(r),t.appendChild(i)});const n=document.createElement("button");n.type="submit",n.textContent=null!==(a=e.form.submitLabel)&&void 0!==a?a:"Continue",n.style.marginTop="10px",n.style.padding="6px 10px",n.style.borderRadius="8px",n.style.border="1px solid #d1d5db",t.appendChild(n),t.onsubmit=e=>{e.preventDefault();const n=new FormData(t);null==s||s(n)},c.appendChild(t)}t.appendChild(c)}function r(t,e,n,s){if(t.innerHTML="",!(null==e?void 0:e.length))return void(t.innerHTML='<div data-testid="assistant-empty">No suggestions</div>');const i=document.createDocumentFragment();e.forEach(t=>{var e,s;const o=document.createElement("div");o.setAttribute("data-testid","assistant-card"),o.style.border="1px solid #e5e7eb",o.style.borderRadius="12px",o.style.padding="12px",o.style.margin="8px 0";const r=document.createElement("div");if(r.textContent=null!==(e=t.title)&&void 0!==e?e:t.type,r.style.fontWeight="600",o.appendChild(r),t.description){const e=document.createElement("div");e.textContent=t.description,e.style.opacity="0.9",e.style.marginTop="4px",o.appendChild(e)}const a=[...null!==(s=t.actions)&&void 0!==s?s:[],...t.primaryCta?[t.primaryCta]:[]].filter(Boolean);if(a.length){const t=document.createElement("div");t.style.display="flex",t.style.flexWrap="wrap",t.style.gap="8px",t.style.marginTop="10px",a.forEach((e,s)=>{const i=document.createElement("button");i.textContent=e.label,i.setAttribute("data-cta-idx",String(s)),i.onclick=()=>n(e),i.style.padding="6px 10px",i.style.borderRadius="8px",i.style.border="1px solid #d1d5db",t.appendChild(i)}),o.appendChild(t)}i.appendChild(o)}),t.appendChild(i)}function a(t){if(null==t)return null;try{const e=typeof t;if("string"===e)return t;if("number"===e||"boolean"===e)return String(t);const n=JSON.stringify(t);return n.length>5e3?n.slice(0,5e3):n}catch(t){return null}}function c(t){if(!t)return null;const e=t.match(/\d+/);if(!e)return null;const n=parseInt(e[0],10);return Number.isFinite(n)?n:null}class l{constructor(t){var e,n;this.bus=new i,this.detachFns=[],this.inflight=!1,this.lastContext={matchedRules:[],eventType:"page_load"},this.cooldownUntil=0,this.trackOn=!1,this.selClick=[],this.selInput=[],this.selMutation=[],this.allow=new Set,this.opts=Object.assign({debounceMs:null!==(e=t.debounceMs)&&void 0!==e?e:150,finalCooldownMs:null!==(n=t.finalCooldownMs)&&void 0!==n?n:3e4},t),this.api=s(t)}on(t,e){return this.bus.on(t,e)}matchesAny(t,e){if(!t)return!1;for(const n of e)try{if(t.closest(n))return!0}catch(t){}return!1}start(){return e(this,void 0,void 0,function*(){try{const t=yield this.api.ruleTrackGet();this.trackProfile=t,this.trackOn="on"===(null==t?void 0:t.status);const e=(null==t?void 0:t.events)||{};this.allow=new Set(Object.keys(e)),this.selClick=Array.isArray(e.dom_click)?e.dom_click:[],this.selInput=Array.isArray(e.input_change)?e.input_change:[],this.selMutation=Array.isArray(e.mutation)?e.mutation:[]}catch(t){this.trackOn=!1,this.allow=new Set(["dom_click","input_change","submit","page_load","route_change"]),this.selClick=[],this.selInput=[],this.selMutation=[]}this.trackOn?this.setupListenersFocusMode():this.setupListenersRichMode()})}setupListenersFocusMode(){this.allow.has("page_load")&&this.schedule(()=>this.handleEvent("page_load",document.body||void 0));const t=t=>{const e=t.target;this.allow.has("dom_click")&&this.matchesAny(e,this.selClick)&&this.schedule(()=>this.handleEvent("dom_click",e))};document.addEventListener("click",t,!0),this.detachFns.push(()=>document.removeEventListener("click",t,!0));const e=t=>{const e=t.target;this.allow.has("input_change")&&this.matchesAny(e,this.selInput)&&this.schedule(()=>this.handleEvent("input_change",e))};document.addEventListener("input",e,!0),document.addEventListener("change",e,!0),this.detachFns.push(()=>document.removeEventListener("input",e,!0)),this.detachFns.push(()=>document.removeEventListener("change",e,!0));const n=t=>{this.allow.has("submit")&&this.schedule(()=>this.handleEvent("submit",t.target))};document.addEventListener("submit",n,!0),this.detachFns.push(()=>document.removeEventListener("submit",n,!0));const s=history.pushState,i=history.replaceState;history.pushState=function(t,e,n){const i=s.apply(this,[t,e,n]);return window.dispatchEvent(new Event("agent-route-change")),i},history.replaceState=function(t,e,n){const s=i.apply(this,[t,e,n]);return window.dispatchEvent(new Event("agent-route-change")),s};const o=()=>{this.allow.has("route_change")&&this.schedule(()=>this.handleEvent("route_change",void 0))};window.addEventListener("popstate",o),window.addEventListener("agent-route-change",o),this.detachFns.push(()=>{window.removeEventListener("popstate",o),window.removeEventListener("agent-route-change",o),history.pushState=s,history.replaceState=i});try{if(this.allow.has("mutation")){const t=t=>{if(t)return t.nodeType===Node.ELEMENT_NODE?t:t.nodeType===Node.TEXT_NODE&&t.parentElement||void 0},e=new MutationObserver(e=>{var n;const s=null===(n=e[0])||void 0===n?void 0:n.target,i=t(s);this.matchesAny(i,this.selMutation)&&this.schedule(()=>this.handleEvent("dom_click",i))});e.observe(document.body,{childList:!0,subtree:!0,characterData:!0,attributes:!0}),this.detachFns.push(()=>e.disconnect())}}catch(t){}}setupListenersRichMode(){this.schedule(()=>this.handleEvent("page_load",document.body||void 0));const t=t=>{this.schedule(()=>this.handleEvent("dom_click",t.target))};document.addEventListener("click",t,!0),this.detachFns.push(()=>document.removeEventListener("click",t,!0));const e=t=>{this.schedule(()=>this.handleEvent("input_change",t.target))};document.addEventListener("input",e,!0),document.addEventListener("change",e,!0),this.detachFns.push(()=>document.removeEventListener("input",e,!0)),this.detachFns.push(()=>document.removeEventListener("change",e,!0));const n=t=>{this.schedule(()=>this.handleEvent("submit",t.target))};document.addEventListener("submit",n,!0),this.detachFns.push(()=>document.removeEventListener("submit",n,!0));const s=history.pushState,i=history.replaceState;history.pushState=function(t,e,n){const i=s.apply(this,[t,e,n]);return window.dispatchEvent(new Event("agent-route-change")),i},history.replaceState=function(t,e,n){const s=i.apply(this,[t,e,n]);return window.dispatchEvent(new Event("agent-route-change")),s};const o=()=>{this.schedule(()=>this.handleEvent("route_change",void 0))};window.addEventListener("popstate",o),window.addEventListener("agent-route-change",o),this.detachFns.push(()=>{window.removeEventListener("popstate",o),window.removeEventListener("agent-route-change",o),history.pushState=s,history.replaceState=i});try{const t=t=>{if(t)return t.nodeType===Node.ELEMENT_NODE?t:t.nodeType===Node.TEXT_NODE&&t.parentElement||void 0},e=new MutationObserver(e=>{var n;const s=null===(n=e[0])||void 0===n?void 0:n.target,i=t(s);this.schedule(()=>this.handleEvent("dom_click",i))});e.observe(document.body,{childList:!0,subtree:!0,characterData:!0,attributes:!0}),this.detachFns.push(()=>e.disconnect())}catch(t){}}stop(){this.detachFns.forEach(t=>{try{t()}catch(t){}}),this.detachFns=[],this.debTimer&&window.clearTimeout(this.debTimer)}answerAsk(t,n){return e(this,void 0,void 0,function*(){try{const{siteId:s,sessionId:i,baseContext:o}=this.opts,r={siteId:s,sessionId:i,prevTurnId:t.turnId,answers:{choice:n.id,value:(e=n,void 0!==e.value?n.value:void 0)},context:Object.assign({},null!=o?o:{})},{turn:a}=yield this.api.suggestGet(r);this.setActiveTurn(a)}catch(t){this.bus.emit("error",t)}var e})}answerForm(t,n){return e(this,void 0,void 0,function*(){try{const{siteId:e,sessionId:s,baseContext:i}=this.opts,o={},r=[];n.forEach((t,e)=>{r.includes(e)||r.push(e)});for(const t of r){const e=n.getAll(t);o[t]=1===e.length?e[0]instanceof File?e[0].name:e[0]:e.map(t=>t instanceof File?t.name:t)}const a={siteId:e,sessionId:s,prevTurnId:t.turnId,answers:o,context:Object.assign({},null!=i?i:{})},{turn:c}=yield this.api.suggestGet(a);this.setActiveTurn(c)}catch(t){this.bus.emit("error",t)}})}schedule(t){this.debTimer&&window.clearTimeout(this.debTimer),this.debTimer=window.setTimeout(t,this.opts.debounceMs)}canOpenConversation(){return this.activeTurn?"ask"!==this.activeTurn.status&&Date.now()>=this.cooldownUntil:Date.now()>=this.cooldownUntil}panelEl(){const t=this.opts.panelSelector;return t?document.querySelector(t):null}setActiveTurn(t){var e,n,s;this.activeTurn=t;const i=this.panelEl();if(i)return t?void("ask"===t.status?(o(i,t,e=>this.answerAsk(t,e),e=>this.answerForm(t,e)),this.bus.emit("turn:ask",t)):(r(i,null!==(n=t.suggestions)&&void 0!==n?n:[],()=>{}),this.bus.emit("suggest:ready",null!==(s=t.suggestions)&&void 0!==s?s:[],t),this.bus.emit("turn:final",t),this.cooldownUntil=Date.now()+this.opts.finalCooldownMs)):(i.innerHTML="",void this.bus.emit("turn:cleared"));"ask"===(null==t?void 0:t.status)?this.bus.emit("turn:ask",t):"final"===(null==t?void 0:t.status)?(this.bus.emit("suggest:ready",null!==(e=t.suggestions)&&void 0!==e?e:[],t),this.bus.emit("turn:final",t),this.cooldownUntil=Date.now()+this.opts.finalCooldownMs):this.bus.emit("turn:cleared")}buildTelemetry(t){var e;const n=t&&1===t.nodeType?t:null,s=n?(n.textContent||"").trim().slice(0,400):null,i=n?n.outerHTML.slice(0,4e3):null,o=n?function(t){var e;const n={};try{for(const s of Array.from(t.attributes))n[s.name]=null!==(e=s.value)&&void 0!==e?e:null}catch(t){}return n}(n):{};try{const t=null==n?void 0:n.closest("[data-action]"),e=null==t?void 0:t.getAttribute("data-action");e&&!("action"in o)&&(o.action=e)}catch(t){}try{const t=[],s=new Map;if(this.trackOn){const e=this.selMutation;if(Array.isArray(e)&&e.length)for(const n of e)try{document.querySelectorAll(n).forEach(e=>{e instanceof Element&&(t.push(e),s.has(e)||s.set(e,u(n)))})}catch(t){}}else if(n){t.push(n);let e=n.parentElement,s=0;for(;e&&s<4;)t.push(e),e=e.parentElement,s++}const i=Array.from(new Set(t)),r=t=>{const e=t.id||"";if(e)return e;const n=[];for(const e of Array.from(t.attributes))e.name.startsWith("data-")&&n.push(e.name.replace(/^data-/,""));const s=n.find(t=>/^(name|counter|count|qty|quantity|total|badge|value)$/i.test(t));if(s)return s;if(n.length)return n[0];const i=(t.getAttribute("class")||"").trim();return i?i.split(/\s+/)[0]:t.tagName?t.tagName.toLowerCase():null};for(const t of i){const n=c((t.textContent||"").trim());if(null==n)continue;const i=this.trackOn?null!==(e=s.get(t))&&void 0!==e?e:null:r(t);i&&(o[d(i)]=String(n))}}catch(t){}const r=n?function(t){try{const e=[];let n=t;for(;n&&1===n.nodeType;){const t=n.nodeName.toLowerCase();let s=t;if(n.id){s+=`#${n.id}`,e.unshift(s);break}{let e=n,i=1;for(;e=e.previousElementSibling;)e.nodeName.toLowerCase()===t&&i++;s+=`:nth-of-type(${i})`}e.unshift(s),n=n.parentElement}return e.join(" > ")}catch(t){return null}}(n):null,l=n?function(t){try{return document.evaluate?(t=>{let e=t;if(e===document.body)return"/html/body";const n=(t,e)=>{let n=1;for(;t;t=t.previousSibling)t.nodeName===e&&n++;return n},s=[];for(;e&&1===e.nodeType;){const t=e,i=e.nodeName.toLowerCase();s.unshift(`${i}[${n(e,i.toUpperCase())}]`),e=t.parentElement}return"/"+s.join("/")})(t):null}catch(t){return null}}(n):null,h=n?function(t){const e=[];try{const n=t=>{if(t.nodeType===Node.TEXT_NODE){const n=(t.textContent||"").trim();n&&e.push(n)}};return t.parentElement&&Array.from(t.parentElement.childNodes).forEach(t=>n(t)),e.slice(0,5)}catch(t){return[]}}(n):[],p=n?function(t){const e=[];try{let n=t.parentElement,s=0;for(;n&&s<6;)e.push({tag:n.tagName||null,id:n.id||null,class:n.getAttribute("class")||null}),n=n.parentElement,s++}catch(t){}return e}(n):[];return{elementText:a(s),elementHtml:a(i),attributes:(m=o,Object.fromEntries(Object.entries(m).map(([t,e])=>[t,null==e?null:String(e)]))),cssPath:a(r),xpath:a(l),nearbyText:h.map(t=>String(t)).slice(0,5),ancestors:p.map(t=>Object.fromEntries(Object.entries(t).map(([t,e])=>[t,null==e?null:String(e)])))};var m}handleEvent(t,n){return e(this,void 0,void 0,function*(){var e;if(!this.inflight){this.inflight=!0;try{const s={siteId:this.opts.siteId,sessionId:this.opts.sessionId,event:{type:t,ts:Date.now(),telemetry:this.buildTelemetry(n)}},i=yield this.api.ruleCheck(s);if(this.bus.emit("rule:checked",i),this.lastContext={matchedRules:i.matchedRules,eventType:i.eventType},!i.shouldProceed||!this.canOpenConversation())return void(i.shouldProceed||this.setActiveTurn(void 0));const o={siteId:this.opts.siteId,sessionId:this.opts.sessionId,context:Object.assign({matchedRules:i.matchedRules,eventType:i.eventType},null!==(e=this.opts.baseContext)&&void 0!==e?e:{})},{turn:r}=yield this.api.suggestGet(o);this.setActiveTurn(r)}catch(t){this.bus.emit("error",t)}finally{this.inflight=!1}}})}}function d(t){return t.replace(/[^a-zA-Z0-9]+(.)/g,(t,e)=>e?e.toUpperCase():"").replace(/^(.)/,t=>t.toLowerCase())}function u(t){const e=t.trim(),n=e.split(/\s*[>+~\s]\s*/).pop()||e,s=n.match(/\[\s*data-([a-zA-Z0-9_-]+)/);if(s)return d(s[1]);const i=n.match(/#([a-zA-Z0-9_-]+)/);if(i)return d(i[1]);const o=n.match(/\.([a-zA-Z0-9_-]+)/);if(o)return d(o[1]);const r=n.match(/\[\s*name="?([a-zA-Z0-9_-]+)/);if(r)return d(r[1]);const a=n.match(/^([a-zA-Z0-9_-]+)/);return d(a?a[1]:n.replace(/[^a-zA-Z0-9]+/g,"-"))}"undefined"!=typeof window&&(window.AgentSDK={AutoAssistant:l,renderAskTurn:o,renderFinalSuggestions:r,createApi:s}),t.AutoAssistant=l,t.createApi=s,t.renderAskTurn=o,t.renderFinalSuggestions=r});
//# sourceMappingURL=sdk.umd.min.js.map
