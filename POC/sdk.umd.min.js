!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).DomSphereSDK={})}(this,function(t){"use strict";function e(t,e,n,s){return new(n||(n=Promise))(function(i,r){function o(t){try{l(s.next(t))}catch(t){r(t)}}function a(t){try{l(s.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,a)}l((s=s.apply(t,e||[])).next())})}function n(t,n,s){return e(this,arguments,void 0,function*(t,e,n,s={}){const i=yield fetch(new URL(e,t).toString(),{method:"POST",headers:Object.assign({"Content-Type":"application/json"},s),body:JSON.stringify(n)});if(!i.ok){const t=yield i.text().catch(()=>"");throw new Error(`HTTP ${i.status} ${i.statusText} @ ${e}: ${t}`)}return yield i.json()})}function s(t){const{baseUrl:s="http://localhost:4000",contractVersion:i=null,requestIdFactory:r,fetchHeaders:o={}}=t,a=()=>Object.assign({"X-Contract-Version":null!=i?i:void 0,"X-Request-Id":null==r?void 0:r()},o);return{ruleCheck:t=>n(s,"/rule/check",t,a()),suggestGet:t=>n(s,"/suggest",t,a()),suggestNext:t=>n(s,"/suggest/next",t,a()),ruleListGet:t=>function(t,n){return e(this,arguments,void 0,function*(t,e,n={}){const s=yield fetch(new URL(e,t).toString(),{method:"GET",headers:Object.assign({"Content-Type":"application/json"},n)});if(!s.ok){const t=yield s.text().catch(()=>"");throw new Error(`HTTP ${s.status} ${s.statusText} @ ${e}: ${t}`)}return yield s.json()})}(s,`/rule?siteId=${encodeURIComponent(t)}`,a())}}"function"==typeof SuppressedError&&SuppressedError;class i{constructor(){this.m=new Map}on(t,e){this.m.has(t)||this.m.set(t,new Set);const n=this.m.get(t);return n?n.add(e):this.m.set(t,new Set([e])),()=>this.off(t,e)}off(t,e){var n;null===(n=this.m.get(t))||void 0===n||n.delete(e)}emit(t,...e){var n;null===(n=this.m.get(t))||void 0===n||n.forEach(t=>{try{t(...e)}catch(t){}})}}function r(t){let e=String(t||"/").trim();return e.startsWith("/")||(e="/"+e),e.length>1&&e.endsWith("/")&&(e=e.slice(0,-1)),e}function o(t){return t.replace(/[^a-zA-Z0-9]+(.)/g,(t,e)=>e?e.toUpperCase():"").replace(/^(.)/,t=>t.toLowerCase())}function a(t,e){return t.has(e)||t.set(e,{paths:new Set,elementIds:new Set,cssPaths:new Set,cssPatterns:[],timeConditions:[],sessionConditions:[]}),t.get(e)}function l(t,e,n){const s=t.get(e);if(!s)return!0;if(0===s.elementIds.size)return!0;if(!n)return!1;let i=n,r=0;for(;i&&r<5;){const t=i.id||"";if(t&&s.elementIds.has(t))return!0;i=i.parentElement,r++}return!1}const c=["--accent-color","--accent","--brand-color","--primary-color","--color-primary","--primary","--link-color","--bs-primary"],u=["--radius-md","--radius","--border-radius","--border-radius-md","--bs-border-radius","border-radius"],d=["--radius-sm","--control-radius","--button-radius","--bs-border-radius-sm","--radius-md","--border-radius","border-radius"];let h=null;function p(t){if(!t)return null;let e=t.trim();if(!e)return null;if("transparent"===e)return{r:0,g:0,b:0,a:0};if(!/^rgb/i.test(e)){const t=function(t){if(!t||"undefined"==typeof window)return null;const e=function(){var t;if("undefined"==typeof document)return null;if(h)return h;const e=document.createElement("span");return e.style.position="fixed",e.style.top="-9999px",e.style.width="0",e.style.height="0",e.style.visibility="hidden",e.style.pointerEvents="none",null===(t=document.body)||void 0===t||t.appendChild(e),h=e,h}();if(!e)return null;e.style.color="",e.style.color=t;const n=window.getComputedStyle(e).color;if(n&&"rgba(0, 0, 0, 0)"!==n&&"transparent"!==n)return n;e.style.backgroundColor="",e.style.backgroundColor=t;const s=window.getComputedStyle(e).backgroundColor;return s&&"rgba(0, 0, 0, 0)"!==s&&"transparent"!==s?s:n||s||null}(e);if(!t)return null;e=t}const n=e.match(/^rgba?\(\s*(\d+(?:\.\d+)?)\s+(\d+(?:\.\d+)?)\s+(\d+(?:\.\d+)?)(?:\s*\/\s*(\d+(?:\.\d+)?))?\s*\)$/i);if(n){const[,t,e,s,i]=n;return g(t,e,s,i)}const s=e.match(/^rgba?\(\s*(\d+(?:\.\d+)?)\s*,\s*(\d+(?:\.\d+)?)\s*,\s*(\d+(?:\.\d+)?)(?:\s*,\s*(\d+(?:\.\d+)?))?\s*\)$/i);if(s){const[,t,e,n,i]=s;return g(t,e,n,i)}return null}function g(t,e,n,s){const i=Number(t),r=Number(e),o=Number(n),a=void 0===s?1:Number(s);return[i,r,o,a].some(t=>Number.isNaN(t))?null:{r:m(i),g:m(r),b:m(o),a:f(a)}}function m(t){return Math.min(255,Math.max(0,t))}function f(t){return Math.min(1,Math.max(0,t))}function y({r:t,g:e,b:n,a:s}){const i=Math.round(1e3*s)/1e3;return i>=1?`rgb(${Math.round(t)}, ${Math.round(e)}, ${Math.round(n)})`:`rgba(${Math.round(t)}, ${Math.round(e)}, ${Math.round(n)}, ${i})`}function v(t,e,n){const s=f(n);return{r:t.r+(e.r-t.r)*s,g:t.g+(e.g-t.g)*s,b:t.b+(e.b-t.b)*s,a:t.a+(e.a-t.a)*s}}function b({r:t,g:e,b:n}){const s=t=>{const e=t/255;return e<=.03928?e/12.92:Math.pow((e+.055)/1.055,2.4)};return.2126*s(t)+.7152*s(e)+.0722*s(n)}function w(t,e){const n=b(t),s=b(e);return(Math.max(n,s)+.05)/(Math.min(n,s)+.05)}const S={r:255,g:255,b:255,a:1},C={r:0,g:0,b:0,a:1};function E(t,e){const n=t;for(const s of e){const e=t.getPropertyValue(s);if(e&&e.trim()&&"0px"!==e.trim())return e.trim();const i=n[T(s)];if("string"==typeof i&&i.trim()&&"0px"!==i.trim())return i.trim()}}function T(t){return t.replace(/-([a-z])/g,(t,e)=>e.toUpperCase())}function x(t){var e,n,s,i,r,o,a,l;const h=function(t){const e=t.closest("[data-assistant-theme-root]");return e instanceof HTMLElement?e:t}(t),g=window.getComputedStyle(h),m=document.body?window.getComputedStyle(document.body):null,f=null!==(n=null!==(e=p(g.color))&&void 0!==e?e:p(null==m?void 0:m.color))&&void 0!==n?n:{r:17,g:24,b:39,a:1},b=null!==(i=null!==(s=p(g.backgroundColor))&&void 0!==s?s:p(null==m?void 0:m.backgroundColor))&&void 0!==i?i:{r:255,g:255,b:255,a:1},T=null!==(o=null!==(r=function(t,e){var n;for(const t of c){const n=p(e.getPropertyValue(t));if(n)return n}const s=t.getAttribute("data-accent-color"),i=p(null!=s?s:void 0);return i||(function(t){if("undefined"==typeof window)return null;const e=t.querySelector("a[href]");if(e){const t=p(window.getComputedStyle(e).color);if(t)return t}if(t!==document.body&&document.body){const t=document.body.querySelector("a[href]");if(t){const e=p(window.getComputedStyle(t).color);if(e)return e}}return null}(t)||(null!==(n=p(e.color))&&void 0!==n?n:null))}(h,g))&&void 0!==r?r:p(g.color))&&void 0!==o?o:f,x=w(k=T,S)>=w(k,C)?S:C;var k;const M=v(b,T,.06);M.a=Math.max(M.a,b.a);const A=y(M),_=v(b,f,.7);_.a=Math.max(_.a,.45);const I=y(_),L=v(f,b,.4);L.a=f.a;const D=y(L),F=v(b,f,.55);F.a=Math.max(F.a,.5);const O=y(F),N=null!==(a=E(g,u))&&void 0!==a?a:"0.75rem",$=null!==(l=E(g,d))&&void 0!==l?l:N;return{accent:y(T),accentText:y(x),border:I,surface:A,text:y(f),subtleText:D,secondaryBorder:O,containerRadius:N,controlRadius:$}}function k(t,e,n){var s;const i=document.createElement("button");i.type="button";const r=(null!=t?t:"").trim()||"Action";return i.textContent=r,i.setAttribute("aria-label",r),i.dataset.assistantVariant=n,i.style.font="inherit",i.style.cursor="pointer",i.style.lineHeight="1.4",i.style.padding="0.55em 0.9em",i.style.borderRadius=e.controlRadius,i.style.borderWidth="1px",i.style.borderStyle="solid",i.style.transition="background-color 120ms ease, border-color 120ms ease, color 120ms ease",i.style.display="inline-flex",i.style.alignItems="center",i.style.justifyContent="center",i.style.gap="0.35em","primary"===n?(i.style.backgroundColor=e.accent,i.style.borderColor=e.accent,i.style.color=e.accentText):(i.style.backgroundColor=null!==(s=e.surface)&&void 0!==s?s:"transparent",i.style.borderColor=e.secondaryBorder,i.style.color=e.text),i}function M(t,e,n){if(t.innerHTML="",!(null==e?void 0:e.length))return void t.removeAttribute("data-assistant-theme");const s=x(t);t.setAttribute("data-assistant-theme","host");const i=document.createDocumentFragment();e.forEach(t=>{var e,r,o,a;const l=t,c=document.createElement("article");c.setAttribute("data-testid","assistant-card"),c.dataset.role="assistant-card",c.style.display="flex",c.style.flexDirection="column",c.style.gap="0.65rem",c.style.border=`1px solid ${s.border}`,c.style.borderRadius=s.containerRadius,c.style.padding="1rem",c.style.margin="0.75rem 0",c.style.backgroundColor=null!==(e=s.surface)&&void 0!==e?e:"transparent",c.style.color=s.text,c.style.boxSizing="border-box";const u=document.createElement("h3");if(u.dataset.role="assistant-title",u.textContent=null!==(r=l.title)&&void 0!==r?r:l.type,u.style.margin="0",u.style.fontWeight="600",u.style.color=s.text,c.appendChild(u),l.description){const t=document.createElement("p");t.dataset.role="assistant-description",t.textContent=l.description,t.style.margin="0",t.style.color=s.subtleText,t.style.fontSize="0.95em",c.appendChild(t)}const d=l.primaryCta?[l.primaryCta]:[],h=l.secondaryCta?[l.secondaryCta]:[],p=(t=>{for(const e of t)if(Array.isArray(e)&&e.length)return e;return[]})([null!==(o=l.secondaryActions)&&void 0!==o?o:[],h,null!==(a=l.actions)&&void 0!==a?a:[]]).slice(0,5),g=t=>{var e,n,s,i;const r=null!==(e=t.kind)&&void 0!==e?e:"",o=null!==(n=t.label)&&void 0!==n?n:"",a=null!==(s=t.payload)&&void 0!==s?s:null,l=null!==(i=t.url)&&void 0!==i?i:"";return`${r}|${o}|${JSON.stringify(a)||""}|${l}`},m=d.length?g(d[0]):null,f=p.filter(t=>g(t)!==m);if(d.length||f.length){const t=document.createElement("div");if(t.dataset.role="assistant-actions",t.style.display="flex",t.style.flexWrap="wrap",t.style.gap="0.5rem",t.style.marginTop="0.5rem",d.length){const e=d[0],i=k(e.label,s,"primary");i.setAttribute("data-cta-kind",String(e.kind||"")),i.onclick=()=>n(e),t.appendChild(i)}f.forEach((e,i)=>{const r=k(e.label,s,"secondary");r.setAttribute("data-cta-idx",String(i)),r.onclick=()=>n(e),t.appendChild(r)}),c.appendChild(t)}i.appendChild(c)}),t.appendChild(i)}function A(t){if(null==t)return null;try{const e=typeof t;if("string"===e)return t;if("number"===e||"boolean"===e)return String(t);const n=JSON.stringify(t);return n.length>5e3?n.slice(0,5e3):n}catch(t){return null}}function _(t){if(!t)return null;const e=t.match(/\d+/);if(!e)return null;const n=parseInt(e[0],10);return Number.isFinite(n)?n:null}class I{sigForCta(t){var e,n,s,i;const r=null!==(e=t.kind)&&void 0!==e?e:"",o=null!==(n=t.label)&&void 0!==n?n:"",a=null!==(s=t.payload)&&void 0!==s?s:null,l=null!==(i=t.url)&&void 0!==i?i:"";return`${String(r)}|${String(o)}|${JSON.stringify(a)||""}|${String(l)}`}constructor(t){var e,n;this.bus=new i,this.detachFns=[],this.inflight=!1,this.cooldownUntil=0,this.trackOn=!1,this.allow=new Set,this.focus=new Map,this.lastSuggestions=[],this.currentStep=1,this.triggeredRules=new Set,this.choiceInput={},this.lastTimeBasedTrigger=0,this.triggeredTimeThresholds=new Set,this.pageLoadTime=Date.now(),this.sessionData={clickCount:0,scrollDepth:0,timeOnSite:0,referrer:document.referrer,userAgent:navigator.userAgent,viewport:`${window.innerWidth}x${window.innerHeight}`},this.timeBasedTimers=new Map,this.opts=Object.assign({debounceMs:null!==(e=t.debounceMs)&&void 0!==e?e:150,finalCooldownMs:null!==(n=t.finalCooldownMs)&&void 0!==n?n:3e4},t),this.api=s(t)}on(t,e){return this.bus.on(t,e)}start(){return e(this,void 0,void 0,function*(){var t;try{const e=yield this.api.ruleListGet(this.opts.siteId),n=(null!==(t=null==e?void 0:e.rules)&&void 0!==t?t:[]).filter(t=>!!t.tracking);if(this.trackOn=n.length>0,this.trackOn){const{focus:t,kinds:e}=function(t){var e,n;const s=new Set,i=new Map;for(const o of t){const t=null!==(e=o.triggers)&&void 0!==e?e:[];for(const e of t){const t=String(e.eventType||"").trim();t&&["dom_click","input_change","submit","page_load","route_change","scroll","time_spent","visibility_change"].includes(t)&&s.add(t);const o=a(i,t);for(const t of null!==(n=e.when)&&void 0!==n?n:[]){const e=String(t.field||""),n=String(t.op||"").toLowerCase(),s=t.value;if("telemetry.attributes.path"===e&&"equals"===n&&"string"==typeof s&&o.paths.add(r(s)),"telemetry.attributes.id"===e&&"equals"===n&&"string"==typeof s&&o.elementIds.add(s),"session.timeOnPage"!==e&&"telemetry.attributes.timeOnPage"!==e||!["gt","gte","lt","lte"].includes(n)||"number"!=typeof s||o.timeConditions.push({op:n,value:s}),e.startsWith("session.")&&"session.timeOnPage"!==e&&o.sessionConditions.push({field:e,op:n,value:s}),"telemetry.cssPath"===e&&"regex"===n&&"string"==typeof s)try{o.cssPatterns.push(new RegExp(s))}catch(t){}}}}return{focus:i,kinds:s}}(n);this.focus=t,this.allow=e.size?e:new Set(["page_load"])}else this.allow=new Set(["dom_click","input_change","submit","page_load","route_change"]);this.bus.emit("rule:ready")}catch(t){this.trackOn=!1,this.allow=new Set(["dom_click","input_change","submit","page_load","route_change"]),this.bus.emit("error",t)}this.trackOn&&this.setupListenersFocusMode()})}setupListenersFocusMode(){this.initializeSessionTracking(),this.allow.has("page_load")&&this.schedule(()=>{const t=this.pickFocusTarget("page_load")||document.body||void 0;this.pathMatches("page_load")&&this.handleEvent("page_load",t)}),this.allow.has("time_spent")&&this.setupTimeBasedEvents();const t=t=>{const e=t.target;if(this.sessionData.clickCount=this.sessionData.clickCount+1,!this.allow.has("dom_click"))return;const n=this.pickFocusTarget("dom_click")||e;this.pathMatches("dom_click")&&this.targetMatches("dom_click",e)&&this.schedule(()=>this.handleEvent("dom_click",n))};document.addEventListener("click",t,!0),this.detachFns.push(()=>document.removeEventListener("click",t,!0));const e=t=>{const e=t.target;if(!this.allow.has("input_change"))return;const n=this.pickFocusTarget("input_change")||e;this.pathMatches("input_change")&&this.targetMatches("input_change",e)&&this.schedule(()=>this.handleEvent("input_change",n))};document.addEventListener("input",e,!0),document.addEventListener("change",e,!0),this.detachFns.push(()=>document.removeEventListener("input",e,!0)),this.detachFns.push(()=>document.removeEventListener("change",e,!0));const n=t=>{if(!this.allow.has("submit"))return;const e=t.target,n=this.pickFocusTarget("submit")||e;this.pathMatches("submit")&&this.targetMatches("submit",e)&&this.schedule(()=>this.handleEvent("submit",n))};document.addEventListener("submit",n,!0),this.detachFns.push(()=>document.removeEventListener("submit",n,!0));const s=history.pushState,i=history.replaceState;history.pushState=function(t,e,n){const i=s.apply(this,[t,e,n]);return window.dispatchEvent(new Event("agent-route-change")),i},history.replaceState=function(t,e,n){const s=i.apply(this,[t,e,n]);return window.dispatchEvent(new Event("agent-route-change")),s};const r=()=>{if(!this.allow.has("route_change"))return;if(!this.pathMatches("route_change"))return;this.triggeredRules.clear(),this.choiceInput={},this.pageLoadTime=Date.now(),this.lastTimeBasedTrigger=0,this.triggeredTimeThresholds.clear(),this.sessionData.clickCount=0,this.sessionData.scrollDepth=0;const t=this.pickFocusTarget("route_change");this.schedule(()=>this.handleEvent("route_change",t))};if(window.addEventListener("popstate",r),window.addEventListener("agent-route-change",r),this.detachFns.push(()=>{window.removeEventListener("popstate",r),window.removeEventListener("agent-route-change",r),history.pushState=s,history.replaceState=i}),this.allow.has("input_change")){const t=this.focus.get("input_change");if(t&&t.elementIds.size>0)try{const e=new MutationObserver(e=>{if(!this.pathMatches("input_change"))return;const n=new Set;for(const s of e){const e=s.target.nodeType===Node.TEXT_NODE?s.target.parentElement:s.target;if(!e)continue;let i=e,r=0;for(;i&&r<5;){const e=i.id||"";if(e&&t.elementIds.has(e)){n.add(i);break}i=i.parentElement,r++}}n.forEach(t=>{this.targetMatches("input_change",t)&&this.schedule(()=>this.handleEvent("input_change",t))})});t.elementIds.forEach(t=>{const n=document.getElementById(t);n&&e.observe(n,{subtree:!0,childList:!0,characterData:!0})}),this.detachFns.push(()=>e.disconnect())}catch(t){}}}pickFocusTarget(t){const e=this.focus.get(t);if(e&&0!==e.elementIds.size)for(const t of e.elementIds){const e=document.getElementById(t);if(e)return e}}pathMatches(t){const e=this.focus.get(t);if(!e)return!0;if(0===e.paths.size)return!0;try{const t=r(window.location.pathname||"/");return e.paths.has(t)}catch(t){return!0}}idMatches(t,e){return l(this.focus,t,e)}targetMatches(t,e){return function(t,e,n){const s=t.get(e);return!s||!(s.elementIds.size>0)||l(t,e,n)}(this.focus,t,e)}shouldEmit(t){return this.pathMatches(t)}stop(){this.detachFns.forEach(t=>{try{t()}catch(t){}}),this.detachFns=[],this.debTimer&&window.clearTimeout(this.debTimer)}schedule(t){this.debTimer&&window.clearTimeout(this.debTimer),this.debTimer=window.setTimeout(t,this.opts.debounceMs)}canOpenPanel(){return Date.now()>=this.cooldownUntil}panelEl(){const t=this.opts.panelSelector;return t?document.querySelector(t):null}closePanel(){const t=this.panelEl();t&&(t.innerHTML="")}renderSuggestions(t){if(!this.panelEl())return;this.lastSuggestions=t;const e=t.map(t=>{var e;const n=t.meta||{},s=Number(null!==(e=n.step)&&void 0!==e?e:1);return Number.isFinite(s)?s:1}).filter(t=>t>0);this.currentStep=e.length?Math.min(...e):1,this.renderStep()}renderStep(){const t=this.panelEl();if(!t)return;const e=this.lastSuggestions.filter(t=>{var e;const n=t.meta||{},s=Number(null!==(e=n.step)&&void 0!==e?e:1);return(Number.isFinite(s)?s:1)===this.currentStep});M(t,e,t=>this.executeCta(t)),this.bus.emit("suggest:ready",e),this.cooldownUntil=Date.now()+this.opts.finalCooldownMs}executeCta(t){return e(this,void 0,void 0,function*(){var n,s;const i=this.inflight;this.inflight=!0;try{const i=String(t.kind||"").toLowerCase();if("function"==typeof this.opts.ctaExecutor)return void this.opts.ctaExecutor(t);const r={dom_fill:t=>{var e,n;const s=null!==(e=t.payload)&&void 0!==e?e:{},i=String(s.selector||""),r=String(null!==(n=s.value)&&void 0!==n?n:""),o=i?document.querySelector(i):null;o&&("value"in o?(o.value=r,o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0}))):o.textContent=r)},click:t=>{var e;const n=null!==(e=t.payload)&&void 0!==e?e:{},s=String(n.selector||""),i=s?document.querySelector(s):null;null==i||i.click()},open:t=>{const e="string"==typeof t.url&&t.url?t.url:"";e&&(window.location.href=e)},choose:t=>e(this,void 0,void 0,function*(){var e,n;const s=null!==(e=t.payload)&&void 0!==e?e:{},i=String(s.name||s.key||"").trim(),r=null!==(n=s.value)&&void 0!==n?n:null;if(i)try{const e=t.nextInput||{},n=Object.assign(Object.assign(Object.assign({},this.choiceInput),{[i]:r}),e),s={siteId:this.opts.siteId,url:window.location.origin+window.location.pathname,ruleId:this.lastRuleId||"",input:n},o=yield this.api.suggestNext(s),a=(null==o?void 0:o.suggestions)||[];Array.isArray(a)&&(this.choiceInput[i]=r,this.renderSuggestions(a))}catch(t){this.bus.emit("error",t)}})},o=t=>e(this,void 0,void 0,function*(){if(Array.isArray(t)&&0!==t.length)for(const e of t){const t=String(e.kind||"").toLowerCase(),n=r[t];n&&(yield Promise.resolve(n(e)))}}),a=(()=>{const e=this.sigForCta(t);for(const t of this.lastSuggestions){const n=t,s=n.primaryCta,i=n.primaryActions,r=n.secondaryActions||(n.secondaryCta?[n.secondaryCta]:[])||n.actions||[];if(s&&this.sigForCta(s)===e)return n;if(Array.isArray(r)&&r.some(t=>this.sigForCta(t)===e))return n;if(Array.isArray(i)&&i.some(t=>this.sigForCta(t)===e))return n}return null})();if((()=>{if(!a||!a.primaryCta)return!1;const e=a.primaryCta,n=this.sigForCta(e)===this.sigForCta(t),s=a.primaryActions||[];return n&&Array.isArray(s)&&s.length>0})()&&a)yield o(a.primaryActions||[]);else{{const e=r[i];e&&(yield Promise.resolve(e(t)))}const e=t.run;yield o(e)}const l=t;if(l.nextClose)return void this.closePanel();if(l.nextId){const t=this.lastSuggestions.find(t=>t.id===l.nextId),e=(null==t?void 0:t.meta)||{},s=Number(null!==(n=e.step)&&void 0!==n?n:0);if(Number.isFinite(s)&&s>0)return this.currentStep=s,void this.renderStep()}const c=Number(null!==(s=l.nextStep)&&void 0!==s?s:l.advanceTo);Number.isFinite(c)&&c>0&&(this.currentStep=c,this.renderStep())}catch(t){this.bus.emit("error",t)}finally{this.inflight=i}})}buildTelemetry(t){const e=t&&1===t.nodeType?t:null;let n=e?(e.textContent||"").trim().slice(0,400):null;try{if(e&&(!n||0===n.length)){const t=e,s=t&&"string"==typeof t.value?t.value:null;null!=s&&(n=String(s).slice(0,400))}}catch(t){}const s=e?e.outerHTML.slice(0,4e3):null,i=e?function(t){var e;const n={};try{for(const s of Array.from(t.attributes))n[s.name]=null!==(e=s.value)&&void 0!==e?e:null}catch(t){}return n}(e):{};try{const t=window.location?window.location.pathname:"/";i.path=r(t)}catch(t){}const a=Math.floor((Date.now()-this.pageLoadTime)/1e3);i.timeOnPage=String(a),i.clickCount=String(this.sessionData.clickCount||0),i.scrollDepth=String(this.sessionData.scrollDepth||0);try{const t=null==e?void 0:e.closest("[data-action]"),n=null==t?void 0:t.getAttribute("data-action");n&&!("action"in i)&&(i.action=n)}catch(t){}try{const t=[];if(e){t.push(e);let n=e.parentElement,s=0;for(;n&&s<4;)t.push(n),n=n.parentElement,s++}const n=Array.from(new Set(t)),s=t=>{const e=t.id||"";if(e)return e;const n=[];for(const e of Array.from(t.attributes))e.name.startsWith("data-")&&n.push(e.name.replace(/^data-/,""));const s=n.find(t=>/^(name|counter|count|qty|quantity|total|badge|value)$/i.test(t));if(s)return s;if(n.length)return n[0];const i=(t.getAttribute("class")||"").trim();return i?i.split(/\s+/)[0]:t.tagName?t.tagName.toLowerCase():null};for(const t of n){const e=_((t.textContent||"").trim());if(null==e)continue;const n=s(t);n&&(i[o(n)]=String(e))}}catch(t){}const l=e?function(t){try{const e=[];let n=t;for(;n&&1===n.nodeType;){const t=n.nodeName.toLowerCase();let s=t;if(n.id){s+=`#${n.id}`,e.unshift(s);break}{let e=n,i=1;for(;e=e.previousElementSibling;)e.nodeName.toLowerCase()===t&&i++;s+=`:nth-of-type(${i})`}e.unshift(s),n=n.parentElement}return e.join(" > ")}catch(t){return null}}(e):null,c=e?function(t){try{return document.evaluate?(t=>{let e=t;if(e===document.body)return"/html/body";const n=(t,e)=>{let n=1;for(;t;t=t.previousSibling)t.nodeName===e&&n++;return n},s=[];for(;e&&1===e.nodeType;){const t=e,i=e.nodeName.toLowerCase();s.unshift(`${i}[${n(e,i.toUpperCase())}]`),e=t.parentElement}return"/"+s.join("/")})(t):null}catch(t){return null}}(e):null,u=e?function(t){const e=[];try{const n=t=>{if(t.nodeType===Node.TEXT_NODE){const n=(t.textContent||"").trim();n&&e.push(n)}};return t.parentElement&&Array.from(t.parentElement.childNodes).forEach(t=>n(t)),e.slice(0,5)}catch(t){return[]}}(e):[],d=e?function(t){const e=[];try{let n=t.parentElement,s=0;for(;n&&s<6;)e.push({tag:n.tagName||null,id:n.id||null,class:n.getAttribute("class")||null}),n=n.parentElement,s++}catch(t){}return e}(e):[];return{elementText:A(n),elementHtml:A(s),attributes:(h=i,Object.fromEntries(Object.entries(h).map(([t,e])=>[t,null==e?null:String(e)]))),cssPath:A(l),xpath:A(c),nearbyText:u.map(t=>String(t)).slice(0,5),ancestors:d.map(t=>Object.fromEntries(Object.entries(t).map(([t,e])=>[t,null==e?null:String(e)])))};var h}handleEvent(t,n){return e(this,void 0,void 0,function*(){if(!this.inflight){this.inflight=!0;try{const e={siteId:this.opts.siteId,sessionId:this.opts.sessionId,event:{type:t,ts:Date.now(),telemetry:this.buildTelemetry(n)}},s=yield this.api.ruleCheck(e);this.bus.emit("rule:checked",s);const i=Array.isArray(s.matchedRules)?s.matchedRules:[],r=i.length?i[i.length-1]:void 0,o=i.join("|"),a=!!o&&o!==this.lastMatchSig;if(r&&this.triggeredRules.has(r))return;if(!s.shouldProceed||!this.canOpenPanel()&&!a)return;if(!r)return;r!==this.lastRuleId&&(this.choiceInput={});const l={siteId:this.opts.siteId,url:window.location.origin+window.location.pathname,ruleId:r},{suggestions:c}=yield this.api.suggestGet(l);this.lastRuleId=r,this.lastMatchSig=o,r&&this.triggeredRules.add(r),this.renderSuggestions(c)}catch(t){this.bus.emit("error",t)}finally{this.inflight=!1}}})}initializeSessionTracking(){if(this.pageLoadTime=Date.now(),this.allow.has("scroll")){const t=()=>{const t=window.pageYOffset||document.documentElement.scrollTop,e=document.documentElement.scrollHeight-window.innerHeight,n=e>0?Math.round(t/e*100):0;this.sessionData.scrollDepth=Math.max(this.sessionData.scrollDepth,n)};window.addEventListener("scroll",t,{passive:!0}),this.detachFns.push(()=>window.removeEventListener("scroll",t))}const t=setInterval(()=>{this.sessionData.timeOnSite=Math.floor((Date.now()-this.pageLoadTime)/1e3)},1e3);this.detachFns.push(()=>clearInterval(t))}setupTimeBasedEvents(){const t=this.focus.get("time_spent");if(!t||0===t.timeConditions.length)return;const e=Math.min(...t.timeConditions.map(t=>t.value)),n=()=>{const e=Math.floor((Date.now()-this.pageLoadTime)/1e3),n=t.timeConditions.filter(({op:t,value:n})=>{if(this.triggeredTimeThresholds.has(n))return!1;switch(t){case"gt":return e>n;case"gte":return e>=n;case"lt":return e<n;case"lte":return e<=n;default:return!1}});n.length>0&&this.pathMatches("time_spent")&&!this.inflight&&(n.forEach(({value:t})=>{this.triggeredTimeThresholds.add(t)}),this.schedule(()=>this.handleEvent("time_spent",document.body)))},s=setTimeout(()=>{n();const t=setInterval(n,1e3);this.detachFns.push(()=>clearInterval(t))},1e3*e);this.detachFns.push(()=>clearTimeout(s))}handleEventWithAdvancedConditions(t,n){return e(this,void 0,void 0,function*(){const e=Math.floor((Date.now()-this.pageLoadTime)/1e3);if(function(t,e,n){return!(void 0!==n.timeOnPage&&!function(t,e,n){const s=t.get(e);return!s||0===s.timeConditions.length||s.timeConditions.every(({op:t,value:e})=>{switch(t){case"gt":return n>e;case"gte":return n>=e;case"lt":return n<e;case"lte":return n<=e;default:return!0}})}(t,e,n.timeOnPage)||n.sessionData&&!function(t,e,n){const s=t.get(e);return!s||0===s.sessionConditions.length||s.sessionConditions.every(({field:t,op:e,value:s})=>{const i=n[t.replace("session.","")];switch(e){case"equals":return i===s;case"gt":return"number"==typeof i&&i>s;case"gte":return"number"==typeof i&&i>=s;case"lt":return"number"==typeof i&&i<s;case"lte":return"number"==typeof i&&i<=s;case"contains":return"string"==typeof i&&i.includes(String(s));case"in":return Array.isArray(s)&&s.includes(i);default:return!0}})}(t,e,n.sessionData))}(this.focus,t,{timeOnPage:e,sessionData:this.sessionData}))return this.handleEvent(t,n)})}}"undefined"!=typeof window&&(window.AgentSDK={AutoAssistant:I,renderFinalSuggestions:M,createApi:s}),t.AutoAssistant=I,t.createApi=s,t.renderFinalSuggestions=M});
//# sourceMappingURL=sdk.umd.min.js.map
